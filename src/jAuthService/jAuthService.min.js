!function(){"use strict";function a(){var a={oauth:!1,jdb:!1,openid:!1,custom:!1},b=!1,c={},d={},e={count:3,expiresIn:12},f={};f.minlength=function(a,b){return!(jEli.$isObject(a)||!a)&&String(a).length>=b},f.maxlength=function(a,b){return!(jEli.$isObject(a)||!a)&&String(a).length<=b},f.emailvalidation=function(a){var b=/^\w+([\.-]?\w+)*@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test(a)},f.domainvalidation=function(a){return/[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+/.test(a)},this.setLoginType=function(c){c&&a[c]&&!b&&(a[c]=!0),b=c},this.loginServiceConfiguration=function(a){if(!jEli.$isObject(a))throw new error("Configuration is expected to be OBJECT not ("+typeof a+")");c=a},this.registerServiceConfiguration=function(a){if(!jEli.$isObject(a))throw new error("Configuration is expected to be OBJECT not ("+typeof a+")");d=a},this.loginTrailSettings=e,this.setValidationConfiguration=function(a,b){return a&&b&&(f[a]=b),this};var g={use:!1,storage:!1,storageType:"sessionStorage"};this.useAuthenticationManager=g,this.$get=function(){var a={authManagerSettings:g};return a.getLoginConfiguration=function(){return c},a.getRegisterConfiguration=function(){return d},a.getLoginType=function(){return b},a.getLoginAttempt=function(a){var b=window[g.storageType].loginAccountTrial;return b&&!a?(delete window[g.storageType].loginAccountTrial,JSON.parse(b)):e},a.getValidationConfiguration=function(){return f},a}}function b(a,b,c,d){function e(a,b,c){k[b].failedValidation[a]=c,k[b].validationFailed=!0}function f(a,b){var c=[];return jEli.forEach(b,function(b,d){var e=!1;l[b.toLowerCase()]?e=(l[b.toLowerCase()]||function(){})(a,d):jEli.$isFunction(d)&&(e=d(a)),e||c.push(b)}),c}function g(a,b){if(!b&&!jEli.$isObject(b))throw new error("Configuration is expected to be Object not ("+typeof b+")");if(k[a]&&jEli.$isObject(b)){k[a].requiresValidation=!0;var c=this;this.validateFields=function(){return k[a].requiresValidation=!1,k[a].failedValidation={},k.validate(a,b),c}}return this}function h(){c.authManagerSettings.storage&&(o=JSON.parse(window[c.authManagerSettings.storageType].getItem("auth-reload")||"{}"),delete window[c.authManagerSettings.storageType]["auth-reload"])}function i(){"onbeforeunload"in window&&jEli.dom(window).bind("beforeunload",function(a){if(jEli.dom.support.localStorage)for(var b in n)window[c.authManagerSettings.storageType].setItem(b,JSON.stringify(n[b]()))})}var j={},k={register:{},login:{},authManager:{}},l=c.getValidationConfiguration(),m=c.getLoginAttempt(),n={};if(k.register.jDB=function(a,b,c){new jEli.$jDB(a.DBNAME,a.version||1).isClientMode().requiresLogin().open(a.resource).onSuccess(function(a){var d=a.result;d._users().add(k.register.postBody).onSuccess(b).onError(c),d.close(!1)})},k.register.custom=function(b,c,d){b.url&&a({url:b.url,dataType:"json",contentType:"application/json",data:k.register.postBody}).then(c,d)},k.login.getHeader=function(){return{"Content-Type":"application/json",Accept:"application/json"}},k.login.oauth=function(c,d,e){var f=k.login.postBody,g=this.getHeader(),h="username="+encodeURIComponent(f.username)+"&password="+encodeURIComponent(f.password)+"&grant_type=password&scope=read%20write";g.Authorization="Basic "+b.encode(c.client_id+":"+c.client_secret),a.post(c.url,h,g).then(d,e)},k.login.custom=function(b,c,d){var e=k.login.postBody,f=this.getHeader();return a.post(b.url,e,f).then(c,d)},k.login.jdb=function(a,b,c){var d=k.login.postBody;new jEli.$jDB(a.DBNAME,a.version||1).isClientMode().requiresLogin().open(a.resource).onSuccess(function(a){var e=a.result;e._users().authorize(d).onSuccess(b).onError(c),e.close(!1)}).onError(c)},k.validate=function(a,b){if(!Object.keys(k[a].postBody).length)return void(this[a].requiresValidation=!0);var c=Object.keys(b),d=0;if(c.filter(function(b){k[a].postBody[b]||(d++,e(b,a,"Field is required"))}),!d){k[a].validationFailed=!1;jEli.forEach(k[a].postBody,function(c,d){var g=[];b[c]&&(g=f(d,b[c])),g.length&&e(c,a,g)})}},j.register={setData:function(a){return k.register.postBody=a,this},setRequiredFields:function(a){return g.apply(this,["register",a])},save:function(a,b){if(k.register.requiresValidation)return void b({reason:"Form Requires Validation - validateFields : API not called",code:"-101"});if(k.register.validationFailed)b({reason:"Failed Validation",fields:k.register.failedValidation,code:"-101"});else{var d=c.getRegisterConfiguration();d&&(d.DBNAME?k.register.jDB(d,a,b):k.register.custom(d,a,b))}}},j.addValidationRule=function(a,b){return a&&jEli.$isFunction(b)&&(l[a]=b),this},j.login={setData:function(a){return k.login.postBody=a,this},setRequiredFields:function(a){return g.apply(this,["login",a])},Authorize:function(a,b){if(!m.count)return b({reason:"Too Many Login attempt",code:"-100"}),void(m.expiresAt||(m.expiresAt=+new Date+36e5*m.expiresIn,n.loginAccountTrial=function(){return m}));if(k.login.requiresValidation)return void b({reason:"Form Requires Validation - validateFields : API not called",code:"-101"});if(k.login.validationFailed)b({reason:"Failed Validation",fields:k.login.failedValidation,code:"-102"});else{var d=c.getLoginConfiguration(),e=c.getLoginType();k.login[e](d,a,function(){m.count--,b.apply(b,arguments)})}}},c.authManagerSettings.use){var o={},p=!1;h(),j.authManager={init:function(){p=!0},isAuthenticated:function(){return p},destroy:function(){o={},p=!1},hasAnyAuthority:function(a,b){if(!p||!b||!b.authorities)return!1;for(var c=0;c<a.length;c++)if(b.authorities.indexOf(a[c])!==-1)return!0;return!1},getData:function(a){return o[a]},storeData:function(a,b){o[a]=b}},n["auth-reload"]=function(){return o}}return j.loginManagement={getExpiresAt:function(){return m.expiresAt},$destroy:function(a){m=c.getLoginAttempt(a)}},i(),j}jEli.jModule("jeli.auth.service",[]).jProvider("jAuthProvider",a).jFactory("jAuthService",["$http","Base64","jAuthProvider","$defer",b])}();