!function(){function a(){function a(a){var b=a.split("/").splice(1),c="/(\\w+)",d={},e=0;for(var f in b)b[f].indexOf(":")>-1?(d[b[f].replace(":","")]=null,b[f]=c):b[f]&&e>0&&(b[f]="/"+b[f]),e++;return{params:d,regexp:new RegExp("^/(?:"+b.join("")+")$"),paramsLength:Object.keys(d).length}}var b={},c=["template","templateUrl","jController","jControllerAs"];this.setState=function(d,e){if(e.route=a(e.url||"^"),e.name=d,e.parent&&b[e.parent]){var f=b[e.parent];e.views=e.views||{};for(var g in f.views)if(g!==e.targetView)e.views[g]=f.views[g];else if(!e.views[g]){e.views[g]={};for(var h=c.length;h--;)e[c[h]]&&(e.views[g][c[h]]=e[c[h]],delete e[c[h]])}if(f.jResolver){e.jResolver=e.jResolver||{};for(var i in f.jResolver)e.jResolver[i]=e.jResolver[i]||f.jResolver[i]}e.route.parent=f,f=null,delete e.parent}return e.url||(e.abstract=!0),b[d]=e,this},this.$get=function(){return b}}function b(){var a,b=this;return this.fallBack=function(b){a=b},this.html5Mode=!1,this.$get=["$jEliWebStateProvider",function(c){function d(a){var b;for(var d in c){var e=c[d];e.route.regexp.test(a)&&(b=e)}return{get:function(){return b},checkParams:function(){if(b&&b.route.paramsLength){var c=b.route.regexp.exec(a).splice(1),d=0;for(var e in b.route.params){var f=c[d],g=parseInt(f);b.route.params[e]=isNaN(g)?f:g,d++}}return b}}}var e=0;return{getRoute:function(b){if(e>2)return e=0,!1;var c=d(b).checkParams();return c?c:void(location.hash="#"+a)},getAllRoute:function(){return c},getRouteObj:function(a){return c[a]},getParentRoute:function(a){return c[a]},getFallBack:function(){return a},isLoaded:!1,getHTML5Mode:function(){return b.html5Mode}}}],this}function c(a){var b=null,c=null;return this.go=function(a,b){return location.hash=this.$href(a,b),this},this.search=function(a){return window.location.search=a},this.$href=function(b,c){var d=a.getRouteObj(b);if(d){var e=d.url.replace(/\:(\w)+/g,function(a,b){var d=a.split(":")[1];return d in c&&c[d]?c[d]:a});return e}return a.getFallBack()},this.state={route:{params:{}}},this.replaceWebState=function(a){(b||a)&&(b={state:"replaceState",hash:"#"+(a||b.previousHash).replace(/^#/,""),previousHash:c,currentLocation:location.hash},jEli.dom(window).triggerHandler("$locationReplaceState"),c=b.hash)},this.$stateChanged=function(a){return this.state.url!==a},this.getRootUrl=function(){var a=document.location.protocol+"//"+(document.location.hostname||document.location.host);return document.location.port&&(a+=":"+document.location.port),a+="/"},this.currentState=function(a){return jEli.$isUndefined(a)?b:void(b=a)},this}function d(a){return{allowType:"AE",$init:function(b,c,d){b.bind("click",function(b){var e=c.where.split(":"),f=e.shift(),g={};e.length&&(g=jEli.$stringToObject(e.join(":"),d)),a.go(a.$href(f,g))})}}}function e(a,b,c,d,e,f,g){function h(a,b,c){q[r]={ele:a,attr:b,model:c,previousModel:null,previousLoaded:!1,name:r}}function i(a){return function(b){return b?q[a][b]:q[a]}}function j(a){}function k(a){var b=c.currentState();s=!0,(b.hash!==b.previousHash||u)&&(location.replace(b.hash),t=b.currentLocation,u=!1)}function l(a){if(!location.hash.length||!c.$stateChanged(m()))return!1;var b=c.currentState();return s?(t!==location.hash&&location.hash!==b.hash&&(u=!0,s=!1,o(m())),!1):void o(m())}function m(){var a=n();return a&&a.indexOf("#")>-1?a.replace("#",""):a}function n(){return s?t:location.hash}function o(a){function h(){if(p=!1,j(),k(),u.template){var a=s.route.parent;a&&!a.views[y.name]||!a?v.$broadcast("$webRouteSuccess",[]):a.route.$model=z,l(),u.jController&&f.instantiate(A,z,null,u.jControllerAs,B),console.log(u),y.ele.empty().append(u.template).compile(z),z.$publish("$viewContentLoaded")(y.ele),y.previousModel=z}}function j(){if(w.length){var a=w.shift();a&&o(a)}}function k(){c.state.route.$model=y.model,c.$$baseUrl=a}function l(){var a=i(r)("previousModel");a&&a.$$destroy({message:"View changed"})}function m(){return s.views?s.views[r]:s}function n(){var a=["data","jResolver","url","name","views","jController","jControllerAs","template","templateUrl","jResolver"],b={};return a.forEach(function(a){s[a]&&(b[a]=s[a])}),b}function q(a,b){b.targetView&&i(b.targetView)()&&(r=b.targetView),!r||b.targetView||b.views||(r="")}if(console.log(p,a),p)return w.push(a),x=currentState!==a,!1;p=!0;var s=d.getRoute(a);if(currentState=a,s){c.state=s;var t=jEli.$extend({},c.state.route);q(a,s);var u=m(),y=i(r)(),z=y.model.$new(),A=u.jController||function(){},B={};v=new jEli.jEvents("addEventListener",function(a){jEli.$isEqual("$webRouteStart",a.type)&&g.instantiate(s.jResolver,B).then(function(){return x?(x=!1,!0):(u.templateUrl?b.get(u.templateUrl).done(function(a){u.template=a.data,h()}):u.template&&h(),void(s.resolvedData=B))})}),v.addEventListener("$webRouteStart",function(a){e.$publish(a.type)(a,n(),s.route.params)}),v.addEventListener("$webRouteSuccess",function(a,b){e.$publish(a.type)(a,s,s.route.params,t,t.params||t.route.params)}),v.$broadcast("$webRouteStart",[])}}var p,q={},r="",s=!1,t=location.hash,u=!1,v=null,w=[],x=!1,y=d.getHTML5Mode();return"onhashchange"in window&&(d.isLoaded||(location.hash=m()||d.getFallBack(),d.isLoaded=!0,jEli.dom(window).bind("hashchange",l).on("$locationReplaceState",k))),"onpopstate"in window&&y&&(window.onpopstate=j),{allowType:"AE",$compiler:function(a,b){return function(a,b,c){r=b.jView||b.ref||"",h(a,b,c),o(m())}}}}jEli.jModule("jEli.web.route",[]).jProvider("$jEliWebProvider",b).jProvider("$jEliWebStateProvider",a).jFactory("$webState",["$jEliWebProvider",c]).jElement("jView",["$jCompiler","$http","$webState","$jEliWebProvider","$rootModel","$controller","$resolve",e]).jElement("go",["$webState",d])}({});