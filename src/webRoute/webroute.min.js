!function(){"use strict";function a(a,b,c){function d(a){}function e(a){var c=b.currentState();i=!0,(c.hash!==c.previousHash||k)&&(location.replace(c.hash),j=c.currentLocation,k=!1)}function f(a){if(!location.hash.length||!b.$stateChanged(g()))return!1;var d=b.currentState();return i?(j!==location.hash&&location.hash!==d.hash&&(k=!0,i=!1,c.events.$broadcast("go")),!1):void c.events.$broadcast("go")}function g(){var a=h();return a&&a.indexOf("#")>-1?a.replace("#",""):a}function h(){return i?j:location.hash}var i=!1,j=location.hash,k=!1,l=a.getHTML5Mode();"onhashchange"in window&&(c.events.listener("go",function(a,b){c.events.$broadcast("go.state",b||g())}),location.hash=g()||a.getFallBack(),a.isLoaded=!0,jEli.dom(window).bind("hashchange",f).on("$locationReplaceState",e),j&&c.events.$broadcast("go")),"onpopstate"in window&&l&&(window.onpopstate=d)}function b(){function a(a){var b=a.split("/").splice(1),c="/(\\w+)",d={},e=0;for(var f in b)b[f].indexOf(":")>-1?(d[b[f].replace(":","")]=null,b[f]=c):b[f]&&e>0&&(b[f]="/"+b[f]),e++;return{params:d,regexp:new RegExp("^/(?:"+b.join("")+")$"),paramsLength:Object.keys(d).length}}var b={},c=["template","templateUrl","jController","jControllerAs"],d={};this.setState=function(e,f){function g(a){for(var b=c.length;b--;)f[c[b]]&&(f.views[a]||(f.views[a]={}),f.views[a][c[b]]=f[c[b]],delete f[c[b]])}f.route=a(f.url||"^");var h=Object.keys(f.views||{});if(f.name=e,f.parent)if(b[f.parent]){var i=b[f.parent];f.views=f.views||{};for(var j in i.views)j!==f.targetView?f.views[j]=i.views[j]:f.views[j]||g(j);var k=f.targetView;if(k&&!f.views[k]&&g(k),i.jResolver){f.jResolver=f.jResolver||{};for(var l in i.jResolver)f.jResolver[l]=f.jResolver[l]||i.jResolver[l]}f.route.parent=i,h.length||f.abstract||(h=i.route.$$views),i.route.$$views.forEach(function(a){jEli.$inArray(h,a)||h.push()}),i=null,delete f.parent}else d[f.parent]||(d[f.parent]=[]),d[f.parent].push(f.name);if(f.url||(f.abstract=!0),b[e]=f,f.route.$$views=h,d[f.name]){var m=this;d[f.name].forEach(function(a){m.setState(a,b[a])}),delete d[f.name]}return this},this.$get=function(){return b}}function c(){var a,b=this;return this.fallBack=function(b){a=b},this.html5Mode=!1,this.$get=["$jEliWebStateProvider",function(c){function d(a){var b;for(var d in c){var e=c[d];e.route.regexp.test(a)&&!e.abstract&&(b=e)}return{get:function(){return b},checkParams:function(){if(b&&b.route.paramsLength){var c=b.route.regexp.exec(a).splice(1),d=0;for(var e in b.route.params){var f=c[d],g=parseInt(f);b.route.params[e]=isNaN(g)?f:g,d++}}return b}}}var e=0;return{getRoute:function(b){if(e>2)return e=0,!1;var c=d(b).checkParams();return c?c:void(location.hash="#"+a)},getAllRoute:function(){return c},getRouteObj:function(a){return c[a]},getParentRoute:function(a){return c[a]},getFallBack:function(){return a},isLoaded:!1,getHTML5Mode:function(){return b.html5Mode}}}],this}function d(a){var b=null,c=null;return this.search=function(a){return window.location.search=a},this.$href=function(b,c){var d=a.getRouteObj(b);if(d){var e=d.url.replace(/\:(\w)+/g,function(a,b){var d=a.split(":")[1];return d in c&&c[d]?c[d]:a});return e}return a.getFallBack()},this.state={route:{params:{}}},this.replaceWebState=function(a){(b||a)&&(b={state:"replaceState",hash:"#"+(a||b.previousHash).replace(/^#/,""),previousHash:c,currentLocation:location.hash},jEli.dom(window).triggerHandler("$locationReplaceState"),c=b.hash)},this.$stateChanged=function(a){return this.state.url!==a},this.getRootUrl=function(){var a=document.location.protocol+"//"+(document.location.hostname||document.location.host);return document.location.port&&(a+=":"+document.location.port),a+="/"},this.currentState=function(a){return jEli.$isUndefined(a)?b:void(b=a)},this}function e(a){return{allowType:"AE",$init:function(b,c,d){b.bind("click",function(b){var e=c.where.split(":"),f=e.shift(),g={};e.length&&(g=jEli.$stringToObject(e.join(":"),d)),a.go(a.$href(f,g))})}}}function f(a,b,c,d,e,f){function g(a){return function(b){return b?m[a][b]:m[a]}}function h(b,c,d){jEli.$isDefined(b)&&(b.templateUrl?a.get(b.templateUrl).done(function(a){b.template=a.data,d(c,b)}):b.template&&d(c,b))}function i(a,c){var d=c.model.$new(),f=a.jController||function(){};if(b.state.route.$model=c.model,a.template){var g=b.state.route.parent;g&&g.views[c.name]&&(g.route.$model=d);var h=c.previousModel;h&&h.$$destroy({message:"View changed"}),a.jController&&e.instantiate(f,d,null,a.jControllerAs,b.state.route.resolvedData),c.ele.empty().append(a.template).compile(d),d.$publish("$viewContentLoaded")(c.ele),c.previousModel=d}}function j(a){if(a.length)for(var b in m)jEli.$inArray(b,a)||delete m[b]}function k(a){function e(){var a=["data","jResolver","url","name","views","jController","jControllerAs","template","templateUrl","jResolver"],b={};return a.forEach(function(a){g[a]&&(b[a]=g[a])}),b}var g=c.getRoute(a);if(g){b.state=g;var h=jEli.$extend({},b.state.route),i={};o=new jEli.jEvents("addEventListener",function(c){jEli.$isEqual("$webRouteStart",c.type)&&(g.jResolver?f.instantiate(g.jResolver,i).then(function(){return q?(q=!1,void s.resolveNextStateQueue()):(s.resolveViews(g)(),b.$$baseUrl=a,s.resolveNextStateQueue(),void(g.resolvedData=i))}):s.resolveViews(g)())}),o.addEventListener("$webRouteStart",function(a){d.$publish(a.type)(a,e(),g.route.params)}),o.addEventListener("$webRouteSuccess",function(a,b){d.$publish(a.type)(a,g,g.route.params,h,h.params||h.route.params)}),o.$broadcast("$webRouteStart",[])}else l=!1}var l,m={},n="@",o=null,p=[],q=!1,r="",s=this,t={};return this.setViewReference=function(a,b,c){return m[b.ref]={ele:a,attr:b,model:c,previousModel:null,previousLoaded:!1,name:b.ref},this},b.go=function(a,b){var c=this.$href(a,b);return s.events.$broadcast("state.changed",c),this},this.events=new jEli.jEvents("listener"),this.events.listener("go.state",function(a,b){l?(p.push(b),q=r!==b):(l=!0,k(b)),r=b}),this.events.listener("view.render",function(a,b){t[b]&&i(t[b],m[b])}),this.events.listener("state.changed",function(a,b){s.events.$broadcast("go.state",b),location.hash=b}),this.resolveNextStateQueue=function(){if(l=!1,p.length){var a=p.shift();a&&this.events.$broadcast("go.state",a)}},this.resolveViews=function(a){var b=[];return a.route.parent&&!a.route.parent.resolved?(a.route.parent.resolved=!0,b=Object.keys(a.views).concat()):a.targetView&&m[a.targetView]?b=b.concat(a.targetView):(b=b.concat(a.route.$$views),j(b)),function(){var c=0;do{n=b[c],c++;var d=a.views?a.views[n]:a;h(d,n,function(a,b){var c=g(a)();c?i(b,c):t[a]=b}),c===b.length-1&&o.$broadcast("$webRouteSuccess",[])}while(b.length>c)}},this}function g(a){return{allowType:"AE",$compiler:function(b,c){return function(b,c,d){c.ref="@"+(c.ref||c.jView||""),a.setViewReference(b,c,d).events.$broadcast("view.render",c.ref)}}}}jEli.jModule("jEli.web.route",[]).jProvider("$jEliWebProvider",c).jProvider("$jEliWebStateProvider",b).jFactory("$webState",["$jEliWebProvider",d]).jFactory("jViewHandler",["$http","$webState","$jEliWebProvider","$rootModel","$controller","$resolve",f]).jElement("jView",["jViewHandler",g]).jElement("go",["$webState",e]).init(["$jEliWebProvider","$webState","jViewHandler",a])}({});