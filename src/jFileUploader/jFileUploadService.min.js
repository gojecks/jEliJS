!function(){"use strict";function b(b){var c=function(){},e=jEli.dom,f={};return c.prototype.bindJquery=function(){return window.jQuery&&(jQuery.fn.jFileUploader=function(){return e(this).live({click:function(){var a=new c;a.selectFile(this)}})},e("[aria-role=upload]").jFileUploader()),this},c.prototype.options={url:"",multipart:!1,singleFileUploads:!0,forceIframeTransport:!1,limitMultiFileUploads:void 0,type:"POST",paramName:null,fileInput:void 0,processData:!1,contentType:!1,cache:!1,dataType:"json",idx:{},fData:function(a){return a.serializeArray()},multipart:!0},c.prototype.buildConfiguration=function(a){var b={container:"",button:"",width:"100",height:"100",loading:'<img src="/loading.gif" />',support:"image/jpg,image/png,image/bmp,image/jpeg,image/gif",callback:function(){}};return this.uOptions=jEli.$extend({},b,a),a.dragArea&&(this.uOptions.dragArea=e("#"+a.dragArea)),this.isFileStarted=!0,this},c.prototype.selectFile=function(a){if(!a.getAttribute("isfileuploadstarted")){var b=e(a),c=this,d=b.data("attr"),f=e("<input />");this.buildConfiguration(b.data("settings")),b.attr("isfileuploadstarted",!0),f.attr(d).on("change",function(a){c._iSpecialOptions(f),c._r(a),a.target.files&&b.hide(1,function(){c.uOptions.button=b}).removeAttr("isfileuploadstarted")}),document.body.onfocus=function(){setTimeout(function(){a.removeAttribute("isfileuploadstarted"),document.body.onfocus=null},100)},f[0].click()}},c.prototype._FData=function(a){var b;return"function"==typeof a.formData?a.fData(a.form):jEli.$isArray(a.formData)?a.fData:jEli.$isObject(a.formData)?(b=[],jEli.forEach(a.formData,function(a,c){b.push({name:a,value:c})}),b):[]},c.prototype._pn=function(a){var b=e(a.fileInput),c=a.paramName;return c?jEli.$isArray(c)||(c=[c]):(c=[],b.each(function(){for(var a=e(this),b=a.prop("name")||"files[]",d=(a.prop("files")||[1]).length;d;)c.push(b),d-=1}),c.length||(c=[b.prop("name")||"file[]"])),c},c.prototype.sl=e.support.slice&&function(){var a=this.slice||this.webkitSlice||this.mozSlice;return a.apply(this,arguments)},c.prototype._isXHRFileUpload=function(a){return!a.forceIframeTransport&&e.support.xhrFileUpload},c.prototype._getDeferredState=function(a){return a.state?a.state():a.isResolved()?"resolved":a.isRejected()?"rejected":"pending"},c.prototype._iProgressObject=function(a){var b={loaded:0,total:0,bitrate:0};a._progress?e.extend(a._progress,b):a._progress=b},c.prototype._iResponseObject=function(a){var b;if(a._response)for(b in a._response)a._response.hasOwnProperty(b)&&delete a._response[b];else a._response={}},c.prototype._addConvenienceMethods=function(a,b){var c=this,d=function(a){return e.Deferred().resolveWith(c,[a]).promise()};b.process=function(a,c){return(a||c)&&(b._processQueue=this._processQueue=(this._processQueue||d(this)).pipe(a,c)),this._processQueue||d(this)},b.submit=function(){return"pending"!==this.state()&&(b.jqXHR=this.jqXHR=c._onSend(a,this)),this.jqXHR},b.abort=function(){if(this.jqXHR)return this.jqXHR.abort()},b.state=function(){return this.jqXHR?c._getDeferredState(this.jqXHR):this._processQueue?c._getDeferredState(this._processQueue):void 0},b.progress=function(){return this._progress},b.response=function(){return this._response}},c.prototype._onAdd=function(a,b){var c,d,f,g,h=this,i=!0,j=e.extend({},this.options,b),k=j.limitMultiFileUploads,l=this._pn(j);if(j.singleFileUploads||k)if(!j.singleFileUpload&&k)for(f=[],c=[],g=0;g<b.files.length;g+=k)f.push(b.files.slice(g,g+k)),d=l.slice(g,g+k),d.length||(d=l),c.push(d);else c=l;else f=[b.files],c=[l];return b.originalFiles=b.files,e.each(f||b.files,function(d,g){var j=e.extend({},b);return j.files=f?g:[g],j.paramName=c[d],j.formData=h.uOptions.formData,h._iResponseObject(j),h._iProgressObject(j),h._addConvenienceMethods(a,j),i=h._add(a,j)}),i},c.prototype._add=function(a,b){var c=(this.options,b.files);b.process(function(){}).always(function(){b.submit(c)})},c.prototype._onTemplate=function(a,b){var c=e.extend({},this.uOptions,b),d=c.files,f=this;return d.length&&e.each(d,function(a,b){f._p([b])}),!1},c.prototype._p=function(a){var b=this;if(a.length>0)for(var c="",d=0;d<a.length;d++){if(c=this._q(a[d].name),void 0!=typeof a[d]){if(this._v(a[d].type)<=0)return;var f=e("<div />").addClass("_duCon").attr("rel",c).css({width:b.uOptions.width+"px",height:b.uOptions.height+"px"}),g=e("<div />").addClass("_lnd").html(b.uOptions.loading),h=e("<div />").addClass("_pCN").css("width",Math.ceil(b.uOptions.width-5)+"px").append('<div class="_pCG"><div class="_isPG" class="0%"></div></div>');f.append(g,h)}b.uOptions.dragArea.append(f).show()}},c.prototype._rfInput=function(a){var b=a.clone(!0);e("<form></form>").append(b)[0].reset(),a.after(b).detach(),e.cleanData(a.unbind("remove")),this.options.fileInput=this.options.fileInput.map(function(c,d){return d===a[0]?b[0]:d}),a[0]===this.options.fileInput[0]&&(this.options.fileInput=inputClone)},c.prototype._iSpecialOptions=function(a){var b=this.options;void 0===b.fileInput?b.fileInput=a:b.fileInput instanceof e||(b.fileInput=e(b.fileInput))},c.prototype._fsInput=function(a){a=e(a);var b,c;if(b=e.makeArray(a.prop("files")),b.length)"undefined"===b[0].name&&b[0].filename&&e.each(b,function(a,b){b.name=b.fileName,b.size=b.fileSize});else{if(c=a.prop("value"),!c)return e.Deferred.resolve([]).promise();b=[{name:value.replace(/^.*\\/,"")}]}return e.Deferred().resolve(b).promise()},c.prototype._fInput=function(a){return a instanceof e&&1!==a.length?e.when.apply(e,e.map(a,this._fsInput)).pipe(function(){return Array.prototype.concat.apply([],arguments)}):this._fsInput(a)},c.prototype._r=function(a){if(e.support.fileReader){var b=this,c={fileInput:e(a.target),form:e(a.target.form)};this._fInput(c.fileInput).always(function(d){c.files=d,b._rfInput(c.fileInput),b._onTemplate(a,c),b._onAdd(a,c)})}else console.log("Failed file reading")},c.prototype._v=function(a){var b=this.uOptions.support.split(",");return b.indexOf(a)},c.prototype._d=function(a){a.stopPropagation(),a.preventDefault(),this._p(a.dataTransfer.files),this.uOptions.all.push(a.dataTransfer.files)},c.prototype._ld=function(a,b,c){function d(d){if(b)f.find("._lnd").show();else if(f.find("._isPG").animate({width:"100%"},250),f.find("._pCN").hide("fast"),f.find("._lnd").hide(),jEli.$isFunction(c))c(!0);else if(g._i("Object",c)){var h=c.data,i=c.link,j=e("<div arial-img='"+a[d]+"'></div>").append(e("<img>").prop("src",i[d]).prop("height",g.uOptions.width)).append(e("<input />").prop("type","hidden").prop("name","link_img[]").val(h[d])).append(e("<a></a>").prop("href","#").attr({ajaxify:"/upload.php","data-settings":'{"imgDel":"'+h[d]+'","idx":"'+a[d]+'","alCN":"'+g.uOptions.formData.album_id+'","setFolder":"'+g.uOptions.formData.setFolder+'"}'}).bind("click",function(){g.__removeImage(this,f)}).html("<span>x</span>")).addClass("_imC");f.append(j).animate({opacity:"100"},250),c.enhance&&g.triggerEvent("file.upload.enhance",c.enhance)}}var f,g=this;this._i("Object",a)||jEli.$isArray(a)?e.each(a,function(a,b){f=e("._duCon[rel='"+b+"']"),d(a)}):(f=e("._duCon[rel='"+a+"']"),d())},c.prototype.__removeImage=function(a,b){var c=e(a).data("settings"),d={},f=this;d.url=e(a).attr("ajaxify"),d.type="POST",d.dataType="html",d.data=c,b.animate({opacity:"30"},250).find("._lnd").show(),c&&e.ajax(d).done(function(a){a&&b.hide(1,function(){e(this).remove(),f.uOptions.button.show()})}).fail(function(){})},c.prototype._ua=function(a){var b=a.files[0],c=a.idx.idx;if(void 0!=typeof b&&this._v(b.type)>0){var d,f=this;this._ld(c,1),d=e.ajax(a),d.done(function(a){f._dn(a)}),d.fail(function(){})}else console.log("Invalid file format - "+b.name);return d},c.prototype._uif=function(b){var c,f,g=0,h=this;this._ld(b.idx,1),f=e("<form></form>"),c=e('<iframe name="'+g+'" src="javascript:false">'),c.bind("load",function(){c.unbind("load").bind("load",function(){var b;try{if(b=c.contents(),!b.length||!b[0].firstChild)throw new Error}catch(a){b=void 0}h._dn(a.ajaxSettings.converters["text "+d.dataType](b.text())),window.setTimeout(function(){f.remove()},0)}),f.prop("method",h.uOptions.type).prop("action",h.uOptions.url).prop("target",c.prop("name")).append(b.data).prop("enctype","multipart/form-data").prop("encoding","multipart/form-data").addClass("hidden_elem"),f.submit(),b.fileInput.each(function(a,b){var c=e(fileInputClones[a]);e(b).prop("name",c.prop("name")),c.replaceWith(b)})}),f.append(c).appendTo("div#page_frame_holder",document)},c.prototype._dn=function(a){var b=this;switch(a.confirm){case"suc":b._ld(a.ids,0,{data:a.data,link:a.imageLink,enhance:a.enhance});break;case"fai":b._ld(a.ids,0,function(){_ftempHolder.html(a.data).remove()})}},c.prototype._onSend=function(a,b){var c,d=this._f(b);return this._isXHRFileUpload(d)?c=this._ua(d):this._uif(d),c},c.prototype._idx=function(a){var b,c=this;this._isXHRFileUpload(a)?(a.idx.idx=this._q(a.files[0].name),a.idx.name=a.files[0].name,a.formData["idx[]"]=a.idx.idx,b=a.idx.idx,a.context=e("._duCon[rel='"+b+"']")):e.each(a.files,function(b,d){a.idx.push({inx:c._q(a.files[b].name)})})},c.prototype._i=function(a,b){return Object.prototype.toString.call(b)==="[object "+a+"]"},c.prototype._iFrameSettings=function(a){e("<div></div>");this.uOptions.formData&&e.each(this.uOptions.formData,function(a,b){e("<input type='hidden' />").prop("name",a).val(b).appendTo(data)}),this._i("Object",a.idx)&&e.each(a.idx,function(a,b){e("<input type='hidden' />").prop("name","idx[]").val(b).appendTo(data)}),a.fileInput&&a.fileInput.length&&"POST"===a.type&&(fileInputclone=a.fileInput.clone(),a.fileInput.after(function(a){return fileInputClones[a]}),fileInputclone.appendTo(data))},c.prototype._onProgress=function(a,b){if(a.lengthComputable){var c=a.position||a.loaded,d=a.totalSize||a.total,e=Math.floor(c/d*1e3)/10+"%";b.context&&b.context.find("._isPG").animate({width:e},250)}},c.prototype._iEventListener=function(a){var b=this,c=a.xhr?a.xhr():e.ajaxSettings.xhr();c.upload&&(e(c.upload).bind("progress",function(c){var d=c.originalEvent;c.lengthComputable=d.lengthComputable,c.loaded=d.loaded,c.total=d.total,b._onProgress(c,a)}),a.xhr=function(){return c})},c.prototype._iXHRData=function(a){var b,c=this,d=a.files[0],f=a.multipart||!e.support.xhrFileUpload;a.headers=a.headers||{};var g=a.paramName[0];f?e.support.isFormData&&(this._i("FormData",a.fData)?b=a.fData:(b=new FormData,e.each(this._FData(a),function(a,c){b.append(c.name,c.value)})),a.blob?b.append(g,a.blob,d.name):e.each(a.files,function(a,d){(c._i("File",d)||c._i("Blob",d))&&b.append(g,d,d.name)}),a.data=b):(a.contentType=d.type,a.data=a.blob||d)},c.prototype._iDataSettings=function(a){this._isXHRFileUpload(a)?(a.data||this._iXHRData(a),this._iEventListener(a)):this._iFrameSettings(a)},c.prototype._iFormSettings=function(a){a.form&&a.form.length||(a.form=e(this.options.fileInput.prop("form")),a.form.length||(a.form=e(this.options.fileInput.prop("form")))),a.paramName=this._pn(a),a.url||(a.url=this.uOptions.formData.url||location.href),a.type=a.type||a.form.prop("method")||"",a.formAcceptCharset||(a.formAcceptCharset=a.form.attr("accept-charset"))},c.prototype._f=function(a){var b=e.extend({},this.options,a);return this._idx(b),this._iFormSettings(b),this._iDataSettings(b),b},c.prototype._q=function(a){return a.replace(/[a-zA-Z]/g,function(a){return String.fromCharCode((a<="Z"?90:122)>=(a=a.charCodeAt(0)+13)?a:a-26)})},c.prototype.triggerEvent=function(a,b){if(f[a])for(var c in f[a])f[a][c].apply(f[a][c],[b])},c.prototype.$on=function(a,b){f[a]||(f[a]=[]),f[a].push(b)},c}function c(a){function b(b,c,d){var e=new a;b.bind("click",function(){e.selectFile(b[0])})}return{$init:b}}jEli.jModule("j.file.uploader",[]).jFactory("jUploadService",["$http",b]).jElement("jFileUpload",["jUploadService",c])}();